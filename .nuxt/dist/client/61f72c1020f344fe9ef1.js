(window.webpackJsonp=window.webpackJsonp||[]).push([[24],{297:function(t,e,n){},298:function(t,e,n){},299:function(t,e,n){"use strict";n(26);var r=n(2),o=n(54);e.a={beforeMount:function(){var t=Object(r.a)(regeneratorRuntime.mark(function t(){var e,n,r=this;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(!this.$store.state.logging){t.next=4;break}e=this.$watch("$store.state.logging",function(){r.$store.state.isAuth?e():r.$toast.error("继续操作前请先登录").then(function(){window.location.href="/"})}),t.next=10;break;case 4:return n=Object(o.a)(),this.$store.commit("SET_USER_TOKEN",n),t.next=8,this.$store.dispatch("initAuth");case 8:t.sent||this.$toast.error("继续操作前请先登录").then(function(){window.location.href="/"});case 10:case"end":return t.stop()}},t,this)}));return function(){return t.apply(this,arguments)}}()}},304:function(t,e,n){"use strict";n(37),n(81);e.a={beforeMount:function(){var t=this,e=this.$watch("isAuth",function(n){n&&(t.$store.getters.isMine(t.$route.params.slug)||t.$router.replace({name:t.$route.name,params:{slug:t.$store.state.user.slug}}),e())})}}},307:function(t,e,n){"use strict";n(296);var r={name:"UserAvatar",props:{user:{type:Object,required:!0},avatar:{type:String,default:""},size:{type:Number,default:40},disabled:{type:Boolean,default:!1}}},o=(n(320),n(25)),component=Object(o.a)(r,function(){var t=this,e=t.$createElement,n=t._self._c||e;return t.disabled?n("div",{staticClass:"user-avatar",style:{width:t.size+"px",height:t.size+"px"}},[n("img",{staticClass:"avatar",attrs:{src:t.$resize(t.avatar||t.user.avatar,{width:t.size}),alt:t.user.nickname}})]):n("nuxt-link",{staticClass:"user-avatar",style:{width:t.size+"px",height:t.size+"px"},attrs:{to:t.$alias.user(t.user.slug)}},[n("img",{staticClass:"avatar",attrs:{src:t.$resize(t.avatar||t.user.avatar,{width:t.size}),alt:t.user.nickname}})])},[],!1,null,null,null);e.a=component.exports},320:function(t,e,n){"use strict";var r=n(297);n.n(r).a},321:function(t,e,n){"use strict";var r=n(298);n.n(r).a},324:function(t,e,n){},325:function(t,e,n){},326:function(t,e,n){},327:function(t,e,n){},328:function(t,e,n){},329:function(t,e,n){},330:function(t,e,n){},331:function(t,e,n){},332:function(t,e,n){},333:function(t,e,n){},347:function(t,e,n){"use strict";n(296);var r={name:"UserNickname",props:{user:{type:Object,required:!0},sex:{type:Number,default:0},level:{type:Boolean,default:!0},nickname:{type:String,default:""},disabled:{type:Boolean,default:!1}},computed:{sexClass:function(){switch(this.sex){case-1:return{name:"simi",color:"limegreen"};case 0:return{name:"unknown",color:"gold"};case 1:return{name:"nan",color:"deepskyblue"};case 2:return{name:"nv",color:"hotpink"};default:return{name:"weizhi",color:"gold"}}}}},o=(n(321),n(25)),component=Object(o.a)(r,function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{staticClass:"clearfix"},[t.disabled?n("div",{staticClass:"user-nickname"},[n("div",{staticClass:"nickname"},[n("p",{staticClass:"oneline",domProps:{textContent:t._s(t.nickname||t.user.nickname)}})]),t._v(" "),t.sex?n("span",{staticClass:"title"},[n("i",{staticClass:"iconfont ic-sex",class:"ic-"+t.sexClass.name,style:{backgroundColor:t.sexClass.color}})]):t._e(),t._v(" "),t.level?n("span",{staticClass:"title ic-level",domProps:{textContent:t._s("Lv"+t.user.level)}}):t._e(),t._v(" "),t._l(t.user.roles,function(e,r){return n("span",{key:r,staticClass:"title ic-title",domProps:{textContent:t._s(e)}})})],2):n("nuxt-link",{staticClass:"user-nickname",attrs:{to:t.$alias.user(t.user.slug)}},[n("div",{staticClass:"nickname"},[n("p",{staticClass:"oneline",domProps:{textContent:t._s(t.nickname||t.user.nickname)}})]),t._v(" "),t.sex?n("span",{staticClass:"title"},[n("i",{staticClass:"iconfont ic-sex",class:"ic-"+t.sexClass.name,style:{backgroundColor:t.sexClass.color}})]):t._e(),t._v(" "),t.level?n("span",{staticClass:"title ic-level",domProps:{textContent:t._s("Lv"+t.user.level)}}):t._e(),t._v(" "),t._l(t.user.title,function(e,r){return n("span",{key:r,staticClass:"title ic-title",domProps:{textContent:t._s(e)}})})],2)],1)},[],!1,null,null,null);e.a=component.exports},371:function(t,e,n){t.exports=n.p+"img/e82d3e7.png"},374:function(t,e,n){"use strict";var r=n(324);n.n(r).a},377:function(t,e,n){"use strict";var r=n(325);n.n(r).a},378:function(t,e,n){"use strict";var r=n(326);n.n(r).a},379:function(t,e,n){"use strict";var r=n(327);n.n(r).a},380:function(t,e,n){"use strict";var r=n(328);n.n(r).a},381:function(t,e,n){"use strict";var r=n(329);n.n(r).a},382:function(t,e,n){"use strict";var r=n(330);n.n(r).a},383:function(t,e,n){"use strict";var r=n(331);n.n(r).a},384:function(t,e,n){"use strict";var r=n(332);n.n(r).a},385:function(t,e,n){"use strict";var r=n(333);n.n(r).a},405:function(t,e,n){"use strict";n.r(e);n(26);var r=n(2),o=n(372),l=n.n(o),c=n(154),m=n(153),d={name:"MessageMenu",props:{slug:{type:String,required:!0}},data:function(){return{filter:"",menuWatcher:null,timeWatcher:null,friends:[]}},computed:{menu:function(){return this.$store.state.messageMenu.list},filterMenu:function(){var t=this;return this.filter?this.menu.filter(function(e){return 0===e.user.nickname.toLocaleLowerCase().indexOf(t.filter.toLocaleLowerCase())}):this.menu}},mounted:function(){var t=this;if(this.menuWatcher=this.$watch("$store.state.mailbox.unread_message_total",function(e,n){e>n&&!t.$store.state.socket.isConnected&&t.getMessageMenu()}),this.timeWatcher=this.$watch("$store.state.messageMenu.time",function(){t.$store.dispatch("updateMessageMenu")}),!this.menu.length||!this.$store.state.socket.isConnected){var e=l.a.service({target:this.$el});this.getUserFriends(),this.getMessageMenu(e)}},beforeDestroy:function(){this.menuWatcher&&this.menuWatcher(),this.timeWatcher&&this.timeWatcher()},methods:{getUserFriends:function(){var t=this,e=function(){Object(c.getUserRelation)({$axios:t.$axios,slug:t.slug,relation:"friends"}).then(function(data){data.result.forEach(function(t){return Object(m.b)(t)}),t.friends=data.result,sessionStorage.setItem("user-friends-list",JSON.stringify(data.result))})};try{var n=sessionStorage.getItem("user-friends-list");if(!n)return void e();var r=JSON.parse(n);r.forEach(function(t){return Object(m.b)(t)}),this.friends=r}catch(t){e()}},getMessageMenu:function(){var t=Object(r.a)(regeneratorRuntime.mark(function t(e){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.$store.dispatch("getMessageMenu");case 2:e.close();case 3:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}(),deleteChannel:function(t){var e=this;this.$axios.$post("v1/message/delete_channel",{channel:t.channel}).then(function(){e.$store.commit("DELETE_MESSAGE_MENU",t.channel)}).catch(function(){})}}},f=(n(374),n(25)),h=Object(f.a)(d,function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("ul",{staticClass:"message-menu"},[n("div",{staticClass:"searcher"},[n("input",{directives:[{name:"model",rawName:"v-model",value:t.filter,expression:"filter"}],attrs:{type:"text",placeholder:"搜索好友"},domProps:{value:t.filter},on:{input:function(e){e.target.composing||(t.filter=e.target.value)}}})]),t._v(" "),t._l(t.filterMenu,function(e){return n("li",{key:e.channel},[n("nuxt-link",{staticClass:"room-item clearfix",attrs:{to:t.$alias.user(t.$route.params.slug,"message/?mailto="+e.channel)}},[n("img",{staticClass:"avatar",attrs:{src:t.$resize(e.user.avatar,{width:42}),alt:e.user.nickname}}),t._v(" "),n("div",{staticClass:"content"},[n("p",{staticClass:"nickname oneline",domProps:{textContent:t._s(e.user.nickname)}}),t._v(" "),n("div",{staticClass:"footer"},[e.count?n("div",{staticClass:"read-badge",domProps:{textContent:t._s(e.count)}}):t._e()])])]),t._v(" "),n("div",{staticClass:"close",on:{click:function(n){return t.deleteChannel(e)}}},[t._v("\n      ×\n    ")])],1)})],2)},[],!1,null,null,null).exports,v=(n(123),n(124),n(12),n(375)),C=n.n(v),_=(n(376),n(307)),x={name:"ChatAvatar",components:{UserAvatar:_.a},props:{item:{type:Object,required:!0}},computed:{isMine:function(){return this.$store.state.user.slug===this.item.slug}}},y=(n(377),Object(f.a)(x,function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"chat-avatar",class:[this.isMine?"chat-avatar-mine":"chat-avatar-other"]},[e("user-avatar",{attrs:{user:this.item,size:36}})],1)},[],!1,null,null,null).exports),$={name:"JsonContentTxtParser",props:{item:{type:Object,required:!0}}},k=(n(378),Object(f.a)($,function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"json-content-txt-parser"},[e("p",{domProps:{innerHTML:this._s(this.item.content.replace(/\r?\n/g,"<br>"))}})])},[],!1,null,null,null).exports),w={name:"JsonContentImgParser",props:{item:{type:Object,required:!0}}},M=(n(379),Object(f.a)(w,function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{staticClass:"json-content-img-parser"},[n("img",{attrs:{src:t.$resize(t.item.url),width:t.item.width,height:t.item.height,alt:t.item.text}}),t._v(" "),t.item.text?n("p",{staticClass:"img-tip",domProps:{textContent:t._s(t.item.text)}}):t._e()])},[],!1,null,null,null).exports),j={name:"JsonContentTxtParser",props:{item:{type:Object,required:!0}}},O=(n(380),Object(f.a)(j,function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"json-content-txt-parser"},[e("blockquote",{domProps:{innerHTML:this._s(this.item.text)}})])},[],!1,null,null,null).exports),E={name:"JsonContentTxtParser",props:{item:{type:Object,required:!0}}},P=(n(381),Object(f.a)(E,function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"json-content-txt-parser"},[this.item.text?e("h3",{domProps:{textContent:this._s(this.item.text)}}):this._e()])},[],!1,null,null,null).exports),L=(n(53),n(81),{name:"JsonContentListParser",props:{item:{type:Object,required:!0}},computed:{list:function(){var t=this.item.text;if(!t)return[];for(;/\n\n/.test(t);)t=t.replace(/\n\n/g,"\n");return t.split("\n")}}}),S=(n(382),{name:"JsonContent",components:{TitleParser:P,TxtParser:k,ImgParser:M,UseParser:O,ListParser:Object(f.a)(L,function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{staticClass:"json-content-list-parser"},["1"===t.item.sort?n("ol",t._l(t.list,function(li,e){return n("li",{key:e,domProps:{textContent:t._s(li)}})}),0):n("ul",t._l(t.list,function(li,e){return n("li",{key:e,domProps:{textContent:t._s(li)}})}),0)])},[],!1,null,null,null).exports},props:{content:{required:!0,type:Array},show:{type:Boolean,default:!0}}}),z={name:"ChatMessage",components:{JsonContent:Object(f.a)(S,function(){var t=this.$createElement,e=this._self._c||t;return this.show?e("div",{staticClass:"json-content"},this._l(this.content,function(t,n){return e(t.type+"-parser",{key:n,tag:"component",attrs:{item:t}})}),1):this._e()},[],!1,null,null,null).exports},props:{item:{type:Object,required:!0}}},A=(n(383),Object(f.a)(z,function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"chat-message"},[e("json-content",{attrs:{content:this.item.content}})],1)},[],!1,null,null,null).exports),T=n(347),U={name:"MessageRoom",components:{ChatRoom:C.a,UserAvatar:_.a,UserNickname:T.a},props:{mailto:{type:String,required:!0},slug:{type:String,required:!0}},data:function(){return{message:"",target:null}},computed:{query:function(){return{channel:this.mailto,$axios:this.$axios}},avatarComp:function(){return y},messageComps:function(){return{message:A}},computeHelperTxt:function(){return"undefined"==typeof window?"":/windows/.test(window.navigator.userAgent.toLocaleLowerCase())?"按下Ctrl+Enter换行":"按下Cmd+Enter换行"}},methods:{handleMessageLoad:function(t){var e=this,data=t.data,n=t.args;this.$nextTick(function(){0===n.is_up&&data.result.map(function(t){e.appendMessage(t)})})},appendMessage:function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.$refs.room.addMessage({id:t.id,type:"message",float:t.user.slug===this.slug?"right":"left",color:2===t.user.sex?{bg:"#ff6881",text:"#fff"}:{bg:"#12b7f5",text:"#fff"},data:t},e)},handleAddBubble:function(){var t=this;if(this.message.trim()){var e=[{type:"txt",content:this.message.trim()}],n=Math.random().toString(10).substring(3,6);this.appendMessage({id:n,user:this.$store.state.user,content:e,created_at:Date.now()}),this.message="",this.$axios.$post("v1/message/send",{message_type:1,getter_slug:this.mailto,content:e}).then(function(e){t.$refs.room.updateMessage(n,{id:e.id}),t.$refs.loader.append(e)}).catch(function(){t.$refs.room.updateMessage(n,{status:"error"})})}},handleNewLine:function(){this.message&&(this.message+="\n")}}},N=(n(384),Object(f.a)(U,function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{staticClass:"room"},[n("div",{staticClass:"room-header"},[t.target?n("user-avatar",{attrs:{user:t.target,size:36}}):t._e(),t._v(" "),t.target?n("user-nickname",{staticClass:"nickname-wrap",attrs:{user:t.target}}):t._e()],1),t._v(" "),n("no-ssr",[n("flow-loader",{ref:"loader",staticClass:"room-body",attrs:{func:"getUserMessage",type:"sinceId",query:t.query,callback:t.handleMessageLoad,"cache-timeout":864e5}},[n("div",{staticClass:"room-chats"},[n("ChatRoom",{ref:"room",attrs:{"avatar-component":t.avatarComp,"message-components":t.messageComps}})],1)])],1),t._v(" "),n("div",{staticClass:"room-footer"},[n("textarea",{directives:[{name:"model",rawName:"v-model",value:t.message,expression:"message"}],attrs:{maxlength:"500",placeholder:"say it..."},domProps:{value:t.message},on:{keydown:[function(e){return!e.type.indexOf("key")&&t._k(e.keyCode,"enter",13,e.key,"Enter")?null:e.ctrlKey||e.shiftKey||e.altKey||e.metaKey?null:(e.preventDefault(),t.handleAddBubble(e))},function(e){return e.ctrlKey?e.shiftKey||e.altKey||e.metaKey?null:(e.preventDefault(),t.handleAddBubble(e)):null},function(e){return!e.type.indexOf("key")&&t._k(e.keyCode,"enter",13,e.key,"Enter")?null:e.metaKey?(e.preventDefault(),t.handleNewLine(e)):null}],input:function(e){e.target.composing||(t.message=e.target.value)}}}),t._v(" "),n("div",{staticClass:"helper"},[n("span",{domProps:{textContent:t._s(t.computeHelperTxt)}}),t._v(" "),n("button",{on:{click:t.handleAddBubble}},[t._v("\n        发送\n      ")])])])],1)},[],!1,null,null,null).exports),J=n(304),K={name:"UserMessage",components:{MessageMenu:h,MessageRoom:N},mixins:[n(299).a,J.a],props:{slug:{type:String,required:!0}},computed:{mailto:function(){return this.$route.query.mailto}}},R=(n(385),Object(f.a)(K,function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("div",{attrs:{id:"user-message"}},[r("el-row",{staticClass:"column-wrap"},[r("el-col",{attrs:{span:6}},[r("message-menu",{attrs:{slug:t.slug}}),t._v("\n       \n    ")],1),t._v(" "),r("el-col",{attrs:{span:18}},[r("div",{staticClass:"room-adjust"},[t.mailto?r("message-room",{attrs:{mailto:t.mailto,slug:t.slug}}):r("div",{staticClass:"need-pick"},[r("img",{attrs:{src:n(371)}}),t._v(" "),r("p",[t._v("未选择聊天")])])],1)])],1)],1)},[],!1,null,null,null));e.default=R.exports}}]);