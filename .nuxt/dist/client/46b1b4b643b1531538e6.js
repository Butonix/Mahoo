(window.webpackJsonp=window.webpackJsonp||[]).push([[24],{254:function(t,e,n){},255:function(t,e,n){},258:function(t,e,n){"use strict";var r=n(2),o=n(37);e.a={beforeMount(){var t=this;return Object(r.a)(function*(){if(t.$store.state.logging){const e=t.$watch("$store.state.logging",()=>{t.$store.state.isAuth?e():t.$toast.error("继续操作前请先登录").then(()=>{window.location.href="/"})})}else{const e=Object(o.a)();t.$store.commit("SET_USER_TOKEN",e),(yield t.$store.dispatch("initAuth"))||t.$toast.error("继续操作前请先登录").then(()=>{window.location.href="/"})}})()}}},261:function(t,e,n){"use strict";var r={name:"UserAvatar",props:{user:{type:Object,required:!0},avatar:{type:String,default:""},size:{type:Number,default:40},disabled:{type:Boolean,default:!1}}},o=(n(274),n(18)),component=Object(o.a)(r,function(){var t=this,e=t.$createElement,n=t._self._c||e;return t.disabled?n("div",{staticClass:"user-avatar",style:{width:t.size+"px",height:t.size+"px"}},[n("img",{staticClass:"avatar",attrs:{src:t.$resize(t.avatar||t.user.avatar,{width:t.size}),alt:t.user.nickname}})]):n("nuxt-link",{staticClass:"user-avatar",style:{width:t.size+"px",height:t.size+"px"},attrs:{to:t.$alias.user(t.user.slug)}},[n("img",{staticClass:"avatar",attrs:{src:t.$resize(t.avatar||t.user.avatar,{width:t.size}),alt:t.user.nickname}})])},[],!1,null,null,null);e.a=component.exports},274:function(t,e,n){"use strict";var r=n(254);n.n(r).a},275:function(t,e,n){"use strict";var r=n(255);n.n(r).a},278:function(t,e,n){},279:function(t,e,n){},280:function(t,e,n){},281:function(t,e,n){},282:function(t,e,n){},283:function(t,e,n){},284:function(t,e,n){},285:function(t,e,n){},286:function(t,e,n){},287:function(t,e,n){},288:function(t,e,n){"use strict";n(61);e.a={beforeMount(){const t=this.$watch("isAuth",e=>{e&&(this.$store.getters.isMine(this.$route.params.slug)||this.$router.replace({name:this.$route.name,params:{slug:this.$store.state.user.slug}}),t())})}}},289:function(t,e,n){},302:function(t,e,n){"use strict";var r={name:"UserNickname",props:{user:{type:Object,required:!0},sex:{type:Number,default:0},level:{type:Boolean,default:!0},nickname:{type:String,default:""},disabled:{type:Boolean,default:!1}},computed:{sexClass(){switch(this.sex){case-1:return{name:"simi",color:"limegreen"};case 0:return{name:"unknown",color:"gold"};case 1:return{name:"nan",color:"deepskyblue"};case 2:return{name:"nv",color:"hotpink"};default:return{name:"weizhi",color:"gold"}}}}},o=(n(275),n(18)),component=Object(o.a)(r,function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{staticClass:"clearfix"},[t.disabled?n("div",{staticClass:"user-nickname"},[n("div",{staticClass:"nickname"},[n("p",{staticClass:"oneline",domProps:{textContent:t._s(t.nickname||t.user.nickname)}})]),t._v(" "),t.sex?n("span",{staticClass:"title"},[n("i",{staticClass:"iconfont ic-sex",class:"ic-"+t.sexClass.name,style:{backgroundColor:t.sexClass.color}})]):t._e(),t._v(" "),t.level?n("span",{staticClass:"title ic-level",domProps:{textContent:t._s("Lv"+t.user.level)}}):t._e(),t._v(" "),t._l(t.user.roles,function(e,r){return n("span",{key:r,staticClass:"title ic-title",domProps:{textContent:t._s(e)}})})],2):n("nuxt-link",{staticClass:"user-nickname",attrs:{to:t.$alias.user(t.user.slug)}},[n("div",{staticClass:"nickname"},[n("p",{staticClass:"oneline",domProps:{textContent:t._s(t.nickname||t.user.nickname)}})]),t._v(" "),t.sex?n("span",{staticClass:"title"},[n("i",{staticClass:"iconfont ic-sex",class:"ic-"+t.sexClass.name,style:{backgroundColor:t.sexClass.color}})]):t._e(),t._v(" "),t.level?n("span",{staticClass:"title ic-level",domProps:{textContent:t._s("Lv"+t.user.level)}}):t._e(),t._v(" "),t._l(t.user.title,function(e,r){return n("span",{key:r,staticClass:"title ic-title",domProps:{textContent:t._s(e)}})})],2)],1)},[],!1,null,null,null);e.a=component.exports},326:function(t,e,n){t.exports=n.p+"img/e82d3e7.png"},329:function(t,e,n){"use strict";var r=n(278);n.n(r).a},332:function(t,e,n){"use strict";var r=n(279);n.n(r).a},333:function(t,e,n){"use strict";var r=n(280);n.n(r).a},334:function(t,e,n){"use strict";var r=n(281);n.n(r).a},335:function(t,e,n){"use strict";var r=n(282);n.n(r).a},336:function(t,e,n){"use strict";var r=n(283);n.n(r).a},337:function(t,e,n){"use strict";var r=n(284);n.n(r).a},338:function(t,e,n){"use strict";var r=n(285);n.n(r).a},341:function(t,e,n){"use strict";var r=n(286);n.n(r).a},342:function(t,e,n){"use strict";var r=n(287);n.n(r).a},343:function(t,e,n){"use strict";var r=n(289);n.n(r).a},362:function(t,e,n){"use strict";n.r(e);var r=n(327),o=n.n(r),l=n(2),c=n(120),h=n(119),m={name:"MessageMenu",props:{slug:{type:String,required:!0}},data:()=>({menuWatcher:null,timeWatcher:null,friends:[]}),computed:{menu(){return this.$store.state.messageMenu.list}},mounted(){this.menuWatcher=this.$watch("$store.state.mailbox.unread_message_total",(t,e)=>{t>e&&!this.$store.state.socket.isConnected&&this.$store.dispatch("getMessageMenu")}),this.timeWatcher=this.$watch("$store.state.messageMenu.time",()=>{this.$store.dispatch("updateMessageMenu")}),this.$store.dispatch("updateMessageMenu"),this.menu.length&&this.$store.state.socket.isConnected||this.initChatRoom()},beforeDestroy(){this.menuWatcher&&this.menuWatcher(),this.timeWatcher&&this.timeWatcher()},methods:{initChatRoom(){var t=this;return Object(l.a)(function*(){const e=o.a.service({target:t.$el});yield t.getUserFriends(),yield t.$store.dispatch("getMessageMenu"),e.close()})()},getUserFriends(){var t=this;return Object(l.a)(function*(){const e=()=>{Object(c.getUserRelation)({$axios:t.$axios,slug:t.slug,relation:"friends"}).then(data=>{data.result.forEach(t=>Object(h.b)(t)),t.friends=data.result,sessionStorage.setItem("user-friends-list",JSON.stringify(data.result))})};try{const n=sessionStorage.getItem("user-friends-list");if(!n)return void(yield e());const r=JSON.parse(n);r.forEach(t=>Object(h.b)(t)),t.friends=r}catch(t){yield e()}})()},deleteChannel(t){this.$axios.$post("v1/message/delete_channel",{channel:t.channel}).then(()=>{this.$store.commit("DELETE_MESSAGE_MENU",t.channel)}).catch(()=>{})}}},d=(n(329),n(18)),f=Object(d.a)(m,function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("ul",{staticClass:"message-menu"},t._l(t.menu,function(e){return n("li",{key:e.channel},[n("nuxt-link",{staticClass:"room-item clearfix",attrs:{to:t.$alias.user(t.$route.params.slug,"message/?mailto="+e.channel)}},[n("img",{staticClass:"avatar",attrs:{src:t.$resize(e.user.avatar,{width:42}),alt:e.user.nickname}}),t._v(" "),n("div",{staticClass:"content"},[n("p",{staticClass:"nickname oneline",domProps:{textContent:t._s(e.user.nickname)}}),t._v(" "),n("div",{staticClass:"footer"},[e.count?n("div",{staticClass:"read-badge",domProps:{textContent:t._s(e.count)}}):t._e()])])]),t._v(" "),n("div",{staticClass:"close",on:{click:function(n){return t.deleteChannel(e)}}},[t._v("\n      ×\n    ")])],1)}),0)},[],!1,null,null,null).exports,v=(n(63),n(330)),C=n.n(v),_=(n(331),n(261)),$={name:"ChatAvatar",components:{UserAvatar:_.a},props:{item:{type:Object,required:!0}},computed:{isMine(){return this.$store.state.user.slug===this.item.slug}}},y=(n(332),Object(d.a)($,function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"chat-avatar",class:[this.isMine?"chat-avatar-mine":"chat-avatar-other"]},[e("user-avatar",{attrs:{user:this.item,size:36}})],1)},[],!1,null,null,null).exports),x={name:"JsonContentTxtParser",props:{item:{type:Object,required:!0}}},k=(n(333),Object(d.a)(x,function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"json-content-txt-parser"},[e("p",{domProps:{innerHTML:this._s(this.item.content.replace(/\r?\n/g,"<br>"))}})])},[],!1,null,null,null).exports),w={name:"JsonContentImgParser",props:{item:{type:Object,required:!0}}},M=(n(334),Object(d.a)(w,function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{staticClass:"json-content-img-parser"},[n("img",{attrs:{src:t.$resize(t.item.url),width:t.item.width,height:t.item.height,alt:t.item.text}}),t._v(" "),t.item.text?n("p",{staticClass:"img-tip",domProps:{textContent:t._s(t.item.text)}}):t._e()])},[],!1,null,null,null).exports),O={name:"JsonContentTxtParser",props:{item:{type:Object,required:!0}}},j=(n(335),Object(d.a)(O,function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"json-content-txt-parser"},[e("blockquote",{domProps:{innerHTML:this._s(this.item.text)}})])},[],!1,null,null,null).exports),E={name:"JsonContentTxtParser",props:{item:{type:Object,required:!0}}},T=(n(336),Object(d.a)(E,function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"json-content-txt-parser"},[this.item.text?e("h3",{domProps:{textContent:this._s(this.item.text)}}):this._e()])},[],!1,null,null,null).exports),S=(n(36),n(61),{name:"JsonContentListParser",props:{item:{type:Object,required:!0}},computed:{list(){let t=this.item.text;if(!t)return[];for(;/\n\n/.test(t);)t=t.replace(/\n\n/g,"\n");return t.split("\n")}}}),P=(n(337),{name:"JsonContent",components:{TitleParser:T,TxtParser:k,ImgParser:M,UseParser:j,ListParser:Object(d.a)(S,function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{staticClass:"json-content-list-parser"},["1"===t.item.sort?n("ol",t._l(t.list,function(li,e){return n("li",{key:e,domProps:{textContent:t._s(li)}})}),0):n("ul",t._l(t.list,function(li,e){return n("li",{key:e,domProps:{textContent:t._s(li)}})}),0)])},[],!1,null,null,null).exports},props:{content:{required:!0,type:Array},show:{type:Boolean,default:!0}}}),A={name:"ChatMessage",components:{JsonContent:Object(d.a)(P,function(){var t=this.$createElement,e=this._self._c||t;return this.show?e("div",{staticClass:"json-content"},this._l(this.content,function(t,n){return e(t.type+"-parser",{key:n,tag:"component",attrs:{item:t}})}),1):this._e()},[],!1,null,null,null).exports},props:{item:{type:Object,required:!0}}},U=(n(338),Object(d.a)(A,function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"chat-message"},[e("json-content",{attrs:{content:this.item.content}})],1)},[],!1,null,null,null).exports),L=n(302),N=n(339),z=n(340),R={name:"VScroll",props:{probeType:{type:Number,default:1},click:{type:Boolean,default:!0},data:{type:Array,default:null},scrollX:{type:Boolean,default:!1}},watch:{data(){this.refresh()}},mounted(){setTimeout(()=>{this._initScroll()},20)},beforeDestroy(){this.scroll&&this.scroll.destroy()},methods:{_initScroll(){this.$refs.wrapper&&(N.a.use(z.a),this.scroll=new N.a(this.$refs.wrapper,{probeType:this.probeType,click:this.click,fade:!0,scrollX:this.scrollX,scrollY:!this.scrollX,mouseWheel:{invert:!1,speed:30,easeTime:300}}),this.scroll.on("scrollEnd",()=>{this.scroll.y>-50&&this.$emit("top"),this.scroll.y<=this.scroll.maxScrollY+50&&this.$emit("bottom")}))},enable(){this.scroll&&this.scroll.enable()},disable(){this.scroll&&this.scroll.disable()},refresh(){return new Promise(t=>{this.$nextTick(()=>{setTimeout(()=>{this.scroll&&this.scroll.refresh(),this.$nextTick(()=>{t()})},20)})})},scrollTo(){setTimeout(()=>{this.scroll&&this.scroll.scrollTo.apply(this.scroll,arguments)},0)},scrollToElement(){setTimeout(()=>{this.scroll&&this.scroll.scrollToElement.apply(this.scroll,arguments)},0)}}},B=(n(341),{name:"MessageRoom",components:{Scroll:Object(d.a)(R,function(){var t=this.$createElement;return(this._self._c||t)("div",{ref:"wrapper",staticClass:"scroll-warp"},[this._t("default")],2)},[],!1,null,null,null).exports,ChatRoom:C.a,UserAvatar:_.a,UserNickname:L.a},props:{mailto:{type:String,required:!0},slug:{type:String,required:!0}},data:()=>({message:"",target:null,chatsHeight:0}),computed:{query(){return{channel:this.mailto,$axios:this.$axios}},avatarComp:()=>y,messageComps:()=>({message:U}),computeHelperTxt:()=>"undefined"==typeof window?"":/windows/.test(window.navigator.userAgent.toLocaleLowerCase())?"按下Ctrl+Enter换行":"按下Cmd+Enter换行"},beforeMount(){this.$store.state.messageRoom[this.mailto]||this.$store.commit("INIT_MESSAGE_ROOM",this.mailto)},mounted(){this.initRoom()},methods:{initRoom(){var t=this;this.$nextTick(Object(l.a)(function*(){yield t.$refs.loader.initData(),yield t.$refs.loader.loadMore({force:!0}),t.clearUnreadCount(),t.watchMessageLoop()}))},clearUnreadCount(){const menu=this.$store.state.messageMenu.list.filter(t=>t.channel===this.mailto)[0];!menu||menu.count<=0||(this.$axios.$post("v1/message/clear_channel",{channel:this.mailto}),this.$store.commit("CLEAR_NOTIFICATION",{channel:this.mailto,count:menu.count}))},watchMessageLoop(){const t=this;this.$watch(function(){return t.$store.getters.msgRoom(t.mailto,"time")},function(){const e=t.$store.getters.msgRoom(t.mailto,"data");t.$store.state.socket.isConnected&&e?t.appendMessage(e):t.$refs.loader.loadMore({force:!0}),t.screenScroll(),t.clearUnreadCount()})},handleScrollUp(){this.$refs.loader.loadBefore()},handleMessageLoad(t){let{data:data,args:e}=t;this.$nextTick(()=>{1===e.is_up?(data.result.map(t=>t).reverse().map(t=>{this.appendMessage(t,!1)}),this.screenScroll(!1)):(data.result.map(t=>{this.appendMessage(t)}),this.screenScroll())})},screenScroll(){let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.$refs.scroll.refresh().then(()=>{const e=this.$refs.room.$el.clientHeight;this.lastChatsHeight&&!t?this.$refs.scroll.scrollTo(0,this.lastChatsHeight-e):this.$refs.scroll.scrollTo(0,this.$refs.wrap.clientHeight-e),this.lastChatsHeight=e})},appendMessage(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.$refs.room.addMessage({id:t.id,type:"message",float:t.user.slug===this.slug?"right":"left",color:2===t.user.sex?{bg:"#ff6881",text:"#fff"}:{bg:"#12b7f5",text:"#fff"},data:t},e)},handleAddBubble(){if(!this.message.trim())return;const t=[{type:"txt",content:this.message.trim()}],e=Math.random().toString(10).substring(3,6);this.appendMessage({id:e,user:this.$store.state.user,content:t,created_at:Date.now()}),this.message="",this.$axios.$post("v1/message/send",{channel:this.mailto,content:t}).then(t=>{this.$refs.room.updateMessage(e,{id:t.id}),this.$refs.loader.append(t),this.screenScroll()}).catch(()=>{this.$refs.room.updateMessage(e,{status:"error"})})},handleNewLine(){this.message&&(this.message+="\n")}}}),J=(n(342),Object(d.a)(B,function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{staticClass:"room"},[n("div",{staticClass:"room-header"},[t.target?n("user-avatar",{attrs:{user:t.target,size:36}}):t._e(),t._v(" "),t.target?n("user-nickname",{staticClass:"nickname-wrap",attrs:{user:t.target}}):t._e()],1),t._v(" "),n("no-ssr",[n("flow-loader",{ref:"loader",staticClass:"room-body",attrs:{func:"getUserMessage",type:"sinceId",sort:"asc",query:t.query,callback:t.handleMessageLoad,"cache-timeout":0,auto:0},scopedSlots:t._u([{key:"default",fn:function(e){var r=e.flow;return n("div",{ref:"wrap",staticClass:"room-chats"},[n("scroll",{ref:"scroll",attrs:{data:r},on:{top:t.handleScrollUp}},[n("chat-room",{ref:"room",attrs:{"avatar-component":t.avatarComp,"message-components":t.messageComps}})],1)],1)}}])})],1),t._v(" "),n("div",{staticClass:"room-footer"},[n("textarea",{directives:[{name:"model",rawName:"v-model",value:t.message,expression:"message"}],attrs:{maxlength:"500",placeholder:"say it..."},domProps:{value:t.message},on:{keydown:[function(e){return!e.type.indexOf("key")&&t._k(e.keyCode,"enter",13,e.key,"Enter")?null:e.ctrlKey||e.shiftKey||e.altKey||e.metaKey?null:(e.preventDefault(),t.handleAddBubble(e))},function(e){return e.ctrlKey?e.shiftKey||e.altKey||e.metaKey?null:(e.preventDefault(),t.handleAddBubble(e)):null},function(e){return!e.type.indexOf("key")&&t._k(e.keyCode,"enter",13,e.key,"Enter")?null:e.metaKey?(e.preventDefault(),t.handleNewLine(e)):null}],input:function(e){e.target.composing||(t.message=e.target.value)}}}),t._v(" "),n("div",{staticClass:"helper"},[n("span",{domProps:{textContent:t._s(t.computeHelperTxt)}}),t._v(" "),n("button",{on:{click:t.handleAddBubble}},[t._v("\n        发送\n      ")])])])],1)},[],!1,null,null,null).exports),H=n(288),I={name:"UserMessage",components:{MessageMenu:f,MessageRoom:J},mixins:[n(258).a,H.a],props:{slug:{type:String,required:!0}},computed:{mailto(){return this.$route.query.mailto}}},K=(n(343),Object(d.a)(I,function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("div",{attrs:{id:"user-message"}},[r("el-row",{staticClass:"column-wrap"},[r("el-col",{attrs:{span:6}},[r("message-menu",{attrs:{slug:t.slug}}),t._v("\n       \n    ")],1),t._v(" "),r("el-col",{attrs:{span:18}},[r("div",{staticClass:"room-adjust"},[t.mailto?r("message-room",{attrs:{mailto:t.mailto,slug:t.slug}}):r("div",{staticClass:"need-pick"},[r("img",{attrs:{src:n(326)}}),t._v(" "),r("p",[t._v("未选择聊天")])])],1)])],1)],1)},[],!1,null,null,null));e.default=K.exports}}]);