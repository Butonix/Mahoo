exports.ids=[21],exports.modules={100:function(t,e,r){"use strict";var n={name:"UserNickname",props:{user:{type:Object,required:!0},sex:{type:Number,default:0},level:{type:Boolean,default:!0},nickname:{type:String,default:""},disabled:{type:Boolean,default:!1}},computed:{sexClass(){switch(this.sex){case-1:return{name:"simi",color:"limegreen"};case 0:return{name:"unknown",color:"gold"};case 1:return{name:"nan",color:"deepskyblue"};case 2:return{name:"nv",color:"hotpink"};default:return{name:"weizhi",color:"gold"}}}}},o=r(1);var component=Object(o.a)(n,function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("div",{staticClass:"clearfix"},[t.disabled?t._ssrNode('<div class="user-nickname">',"</div>",[t._ssrNode('<div class="nickname"><p class="oneline">'+t._ssrEscape(t._s(t.nickname||t.user.nickname))+"</p></div> "+(t.sex?'<span class="title"><i'+t._ssrClass("iconfont ic-sex","ic-"+t.sexClass.name)+t._ssrStyle(null,{backgroundColor:t.sexClass.color},null)+"></i></span>":"\x3c!----\x3e")+" "+(t.level?'<span class="title ic-level">'+t._ssrEscape(t._s("Lv"+t.user.level))+"</span>":"\x3c!----\x3e")+" "+t._ssrList(t.user.roles,function(e,r){return'<span class="title ic-title">'+t._ssrEscape(t._s(e))+"</span>"}))],2):r("nuxt-link",{staticClass:"user-nickname",attrs:{to:t.$alias.user(t.user.slug)}},[r("div",{staticClass:"nickname"},[r("p",{staticClass:"oneline",domProps:{textContent:t._s(t.nickname||t.user.nickname)}})]),t._v(" "),t.sex?r("span",{staticClass:"title"},[r("i",{staticClass:"iconfont ic-sex",class:"ic-"+t.sexClass.name,style:{backgroundColor:t.sexClass.color}})]):t._e(),t._v(" "),t.level?r("span",{staticClass:"title ic-level",domProps:{textContent:t._s("Lv"+t.user.level)}}):t._e(),t._v(" "),t._l(t.user.title,function(e,n){return r("span",{key:n,staticClass:"title ic-title",domProps:{textContent:t._s(e)}})})],2)],1)},[],!1,function(t){var e=r(73);e.__inject__&&e.__inject__(t)},null,"5b0047c6");e.a=component.exports},109:function(t,e,r){t.exports=r.p+"img/e82d3e7.png"},110:function(t,e,r){"use strict";r.r(e);var n=r(76),o=r.n(n);for(var c in n)"default"!==c&&function(t){r.d(e,t,function(){return n[t]})}(c);e.default=o.a},111:function(t,e){},112:function(t,e,r){"use strict";r.r(e);var n=r(77),o=r.n(n);for(var c in n)"default"!==c&&function(t){r.d(e,t,function(){return n[t]})}(c);e.default=o.a},113:function(t,e,r){"use strict";r.r(e);var n=r(78),o=r.n(n);for(var c in n)"default"!==c&&function(t){r.d(e,t,function(){return n[t]})}(c);e.default=o.a},114:function(t,e,r){"use strict";r.r(e);var n=r(79),o=r.n(n);for(var c in n)"default"!==c&&function(t){r.d(e,t,function(){return n[t]})}(c);e.default=o.a},115:function(t,e,r){"use strict";r.r(e);var n=r(80),o=r.n(n);for(var c in n)"default"!==c&&function(t){r.d(e,t,function(){return n[t]})}(c);e.default=o.a},116:function(t,e,r){"use strict";r.r(e);var n=r(81),o=r.n(n);for(var c in n)"default"!==c&&function(t){r.d(e,t,function(){return n[t]})}(c);e.default=o.a},117:function(t,e,r){"use strict";r.r(e);var n=r(82),o=r.n(n);for(var c in n)"default"!==c&&function(t){r.d(e,t,function(){return n[t]})}(c);e.default=o.a},118:function(t,e,r){"use strict";r.r(e);var n=r(83),o=r.n(n);for(var c in n)"default"!==c&&function(t){r.d(e,t,function(){return n[t]})}(c);e.default=o.a},119:function(t,e,r){"use strict";r.r(e);var n=r(84),o=r.n(n);for(var c in n)"default"!==c&&function(t){r.d(e,t,function(){return n[t]})}(c);e.default=o.a},120:function(t,e,r){"use strict";r.r(e);var n=r(85),o=r.n(n);for(var c in n)"default"!==c&&function(t){r.d(e,t,function(){return n[t]})}(c);e.default=o.a},121:function(t,e,r){"use strict";r.r(e);var n=r(86),o=r.n(n);for(var c in n)"default"!==c&&function(t){r.d(e,t,function(){return n[t]})}(c);e.default=o.a},135:function(t,e,r){"use strict";r.r(e);var n=r(51),o=r.n(n),c=r(24),l=r(23),d={name:"MessageMenu",props:{slug:{type:String,required:!0}},data:()=>({menuWatcher:null,timeWatcher:null,friends:[]}),computed:{menu(){return this.$store.state.messageMenu.list}},mounted(){this.menuWatcher=this.$watch("$store.state.mailbox.unread_message_total",(t,e)=>{t>e&&!this.$store.state.socket.isConnected&&this.$store.dispatch("getMessageMenu")}),this.timeWatcher=this.$watch("$store.state.messageMenu.time",()=>{this.$store.dispatch("updateMessageMenu")}),this.menu.length&&this.$store.state.socket.isConnected||this.initChatRoom()},beforeDestroy(){this.menuWatcher&&this.menuWatcher(),this.timeWatcher&&this.timeWatcher()},methods:{async initChatRoom(){const t=o.a.service({target:this.$el});await this.getUserFriends(),await this.$store.dispatch("getMessageMenu"),t.close()},async getUserFriends(){const t=()=>{Object(c.getUserRelation)({$axios:this.$axios,slug:this.slug,relation:"friends"}).then(data=>{data.result.forEach(t=>Object(l.b)(t)),this.friends=data.result,sessionStorage.setItem("user-friends-list",JSON.stringify(data.result))})};try{const e=sessionStorage.getItem("user-friends-list");if(!e)return void await t();const r=JSON.parse(e);r.forEach(t=>Object(l.b)(t)),this.friends=r}catch(e){await t()}},deleteChannel(t){this.$axios.$post("v1/message/delete_channel",{channel:t.channel}).then(()=>{this.$store.commit("DELETE_MESSAGE_MENU",t.channel)}).catch(()=>{})}}},h=r(1);var f=Object(h.a)(d,function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("ul",{staticClass:"message-menu"},t._l(t.menu,function(e){return t._ssrNode("<li>","</li>",[r("nuxt-link",{staticClass:"room-item clearfix",attrs:{to:t.$alias.user(t.$route.params.slug,"message/?mailto="+e.channel)}},[r("img",{staticClass:"avatar",attrs:{src:t.$resize(e.user.avatar,{width:42}),alt:e.user.nickname}}),t._v(" "),r("div",{staticClass:"content"},[r("p",{staticClass:"nickname oneline",domProps:{textContent:t._s(e.user.nickname)}}),t._v(" "),r("div",{staticClass:"footer"},[e.count?r("div",{staticClass:"read-badge",domProps:{textContent:t._s(e.count)}}):t._e()])])]),t._ssrNode(' <div class="close">\n      ×\n    </div>')],2)}),0)},[],!1,function(t){var e=r(110);e.__inject__&&e.__inject__(t)},null,"04b91794").exports,m=r(52),_=r.n(m),v=(r(111),r(65)),x={name:"ChatAvatar",components:{UserAvatar:v.a},props:{item:{type:Object,required:!0}},computed:{isMine(){return this.$store.state.user.slug===this.item.slug}}};var $=Object(h.a)(x,function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"chat-avatar",class:[this.isMine?"chat-avatar-mine":"chat-avatar-other"]},[e("user-avatar",{attrs:{user:this.item,size:36}})],1)},[],!1,function(t){var e=r(112);e.__inject__&&e.__inject__(t)},null,"630a9f70").exports,C={name:"JsonContentTxtParser",props:{item:{type:Object,required:!0}}};var y=Object(h.a)(C,function(){var t=this.$createElement;return(this._self._c||t)("div",{staticClass:"json-content-txt-parser"},[this._ssrNode("<p>"+this._s(this.item.content.replace(/\r?\n/g,"<br>"))+"</p>")])},[],!1,function(t){var e=r(113);e.__inject__&&e.__inject__(t)},null,"a8aa203e").exports,j={name:"JsonContentImgParser",props:{item:{type:Object,required:!0}}};var w=Object(h.a)(j,function(){var t=this,e=t.$createElement;return(t._self._c||e)("div",{staticClass:"json-content-img-parser"},[t._ssrNode("<img"+t._ssrAttr("src",t.$resize(t.item.url))+t._ssrAttr("width",t.item.width)+t._ssrAttr("height",t.item.height)+t._ssrAttr("alt",t.item.text)+"> "+(t.item.text?'<p class="img-tip">'+t._ssrEscape(t._s(t.item.text))+"</p>":"\x3c!----\x3e"))])},[],!1,function(t){var e=r(114);e.__inject__&&e.__inject__(t)},null,"f06b0d18").exports,k={name:"JsonContentTxtParser",props:{item:{type:Object,required:!0}}};var E=Object(h.a)(k,function(){var t=this.$createElement;return(this._self._c||t)("div",{staticClass:"json-content-txt-parser"},[this._ssrNode("<blockquote>"+this._s(this.item.text)+"</blockquote>")])},[],!1,function(t){var e=r(115);e.__inject__&&e.__inject__(t)},null,"8b617b90").exports,M={name:"JsonContentTxtParser",props:{item:{type:Object,required:!0}}};var O=Object(h.a)(M,function(){var t=this.$createElement;return(this._self._c||t)("div",{staticClass:"json-content-txt-parser"},[this._ssrNode(this.item.text?"<h3>"+this._ssrEscape(this._s(this.item.text))+"</h3>":"\x3c!----\x3e")])},[],!1,function(t){var e=r(116);e.__inject__&&e.__inject__(t)},null,"55f76f49").exports,T={name:"JsonContentListParser",props:{item:{type:Object,required:!0}},computed:{list(){let t=this.item.text;if(!t)return[];for(;/\n\n/.test(t);)t=t.replace(/\n\n/g,"\n");return t.split("\n")}}};var N={name:"JsonContent",components:{TitleParser:O,TxtParser:y,ImgParser:w,UseParser:E,ListParser:Object(h.a)(T,function(){var t=this,e=t.$createElement;return(t._self._c||e)("div",{staticClass:"json-content-list-parser"},[t._ssrNode("1"===t.item.sort?"<ol>"+t._ssrList(t.list,function(li,e){return"<li>"+t._ssrEscape(t._s(li))+"</li>"})+"</ol>":"<ul>"+t._ssrList(t.list,function(li,e){return"<li>"+t._ssrEscape(t._s(li))+"</li>"})+"</ul>")])},[],!1,function(t){var e=r(117);e.__inject__&&e.__inject__(t)},null,"0247939b").exports},props:{content:{required:!0,type:Array},show:{type:Boolean,default:!0}}},S={name:"ChatMessage",components:{JsonContent:Object(h.a)(N,function(){var t=this.$createElement,e=this._self._c||t;return this.show?e("div",{staticClass:"json-content"},this._l(this.content,function(t,r){return e(t.type+"-parser",{key:r,tag:"component",attrs:{item:t}})}),1):this._e()},[],!1,null,null,"db874c02").exports},props:{item:{type:Object,required:!0}}};var A=Object(h.a)(S,function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"chat-message"},[e("json-content",{attrs:{content:this.item.content}})],1)},[],!1,function(t){var e=r(118);e.__inject__&&e.__inject__(t)},null,"959e5200").exports,P=r(100),z=r(53),L=r.n(z),U=r(54),J=r.n(U),R={name:"VScroll",props:{probeType:{type:Number,default:1},click:{type:Boolean,default:!0},data:{type:Array,default:null},scrollX:{type:Boolean,default:!1}},watch:{data(){setTimeout(()=>{this.refresh()},20)}},mounted(){setTimeout(()=>{this._initScroll()},20)},beforeDestroy(){this.scroll&&this.scroll.destroy()},methods:{_initScroll(){this.$refs.wrapper&&(L.a.use(J.a),this.scroll=new L.a(this.$refs.wrapper,{probeType:this.probeType,click:this.click,fade:!0,scrollX:this.scrollX,scrollY:!this.scrollX,mouseWheel:{invert:!1,speed:30,easeTime:300}}),this.scroll.on("scrollEnd",()=>{this.scroll.y>-50&&this.$emit("on-top"),this.scroll.y<=this.scroll.maxScrollY+50&&this.$emit("on-bottom")}))},enable(){this.scroll&&this.scroll.enable()},disable(){this.scroll&&this.scroll.disable()},refresh(){this.$nextTick(()=>{this.scroll&&this.scroll.refresh()})},scrollTo(){setTimeout(()=>{this.scroll&&this.scroll.scrollTo.apply(this.scroll,arguments)},0)},scrollToElement(){setTimeout(()=>{this.scroll&&this.scroll.scrollToElement.apply(this.scroll,arguments)},0)}}};var W={name:"MessageRoom",components:{Scroll:Object(h.a)(R,function(){var t=this.$createElement;return(this._self._c||t)("div",{ref:"wrapper",staticClass:"scroll-warp"},[this._t("default")],2)},[],!1,function(t){var e=r(119);e.__inject__&&e.__inject__(t)},null,"2a757871").exports,ChatRoom:_.a,UserAvatar:v.a,UserNickname:P.a},props:{mailto:{type:String,required:!0},slug:{type:String,required:!0}},data:()=>({message:"",target:null}),computed:{query(){return{channel:this.mailto,$axios:this.$axios}},count(){return parseInt(this.$route.query.count||-1)},avatarComp:()=>$,messageComps:()=>({message:A}),computeHelperTxt:()=>"undefined"==typeof window?"":/windows/.test(window.navigator.userAgent.toLocaleLowerCase())?"按下Ctrl+Enter换行":"按下Cmd+Enter换行"},beforeMount(){this.$store.state.messageRoom[this.mailto]||this.$store.commit("INIT_MESSAGE_ROOM",this.mailto)},mounted(){this.$nextTick(()=>{this.$refs.loader.initData()})},methods:{handleMessageLoad({data:data,args:t}){this.$nextTick(()=>{1===t.is_up&&(data.result.map(t=>{this.appendMessage(t)}),this.$nextTick(()=>{this.$refs.scroll.scrollTo(0,this.$refs.wrap.clientHeight-this.$refs.room.$el.clientHeight)}))})},appendMessage(t,e=!0){this.$refs.room.addMessage({id:t.id,type:"message",float:t.user.slug===this.slug?"right":"left",color:2===t.user.sex?{bg:"#ff6881",text:"#fff"}:{bg:"#12b7f5",text:"#fff"},data:t},e)},handleAddBubble(){if(!this.message.trim())return;const t=[{type:"txt",content:this.message.trim()}],e=Math.random().toString(10).substring(3,6);this.appendMessage({id:e,user:this.$store.state.user,content:t,created_at:Date.now()}),this.message="",this.$axios.$post("v1/message/send",{channel:this.mailto,content:t}).then(t=>{this.$refs.room.updateMessage(e,{id:t.id}),this.$refs.loader.append(t)}).catch(()=>{this.$refs.room.updateMessage(e,{status:"error"})})},handleNewLine(){this.message&&(this.message+="\n")}}};var I=Object(h.a)(W,function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("div",{staticClass:"room"},[t._ssrNode('<div class="room-header">',"</div>",[t.target?r("user-avatar",{attrs:{user:t.target,size:36}}):t._e(),t._ssrNode(" "),t.target?r("user-nickname",{staticClass:"nickname-wrap",attrs:{user:t.target}}):t._e()],2),t._ssrNode(" "),r("no-ssr",[r("flow-loader",{ref:"loader",staticClass:"room-body",attrs:{func:"getUserMessage",type:"sinceId",sort:"asc",query:t.query,callback:t.handleMessageLoad,"cache-timeout":864e5,auto:0},scopedSlots:t._u([{key:"default",fn:function(e){var n=e.flow;return r("div",{ref:"wrap",staticClass:"room-chats"},[r("scroll",{ref:"scroll",attrs:{data:n}},[r("chat-room",{ref:"room",attrs:{"avatar-component":t.avatarComp,"message-components":t.messageComps}})],1)],1)}}])})],1),t._ssrNode(' <div class="room-footer"><textarea maxlength="500" placeholder="say it...">'+t._ssrEscape(t._s(t.message))+'</textarea> <div class="helper"><span>'+t._ssrEscape(t._s(t.computeHelperTxt))+"</span> <button>\n        发送\n      </button></div></div>")],2)},[],!1,function(t){var e=r(120);e.__inject__&&e.__inject__(t)},null,"174bc1b2").exports,B=r(63),D={name:"UserMessage",components:{MessageMenu:f,MessageRoom:I},mixins:[r(61).a,B.a],props:{slug:{type:String,required:!0}},computed:{mailto(){return this.$route.query.mailto}}};var H=Object(h.a)(D,function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{attrs:{id:"user-message"}},[n("el-row",{staticClass:"column-wrap"},[n("el-col",{attrs:{span:6}},[n("message-menu",{attrs:{slug:t.slug}}),t._v("\n       \n    ")],1),t._v(" "),n("el-col",{attrs:{span:18}},[n("div",{staticClass:"room-adjust"},[t.mailto?n("message-room",{attrs:{mailto:t.mailto,slug:t.slug}}):n("div",{staticClass:"need-pick"},[n("img",{attrs:{src:r(109)}}),t._v(" "),n("p",[t._v("未选择聊天")])])],1)])],1)],1)},[],!1,function(t){var e=r(121);e.__inject__&&e.__inject__(t)},null,"1992ef02");e.default=H.exports},59:function(t,e){},60:function(t,e){},61:function(t,e,r){"use strict";var n=r(21);e.a={async beforeMount(){if(this.$store.state.logging){const t=this.$watch("$store.state.logging",()=>{this.$store.state.isAuth?t():this.$toast.error("继续操作前请先登录").then(()=>{window.location.href="/"})})}else{const t=Object(n.a)();this.$store.commit("SET_USER_TOKEN",t),await this.$store.dispatch("initAuth")||this.$toast.error("继续操作前请先登录").then(()=>{window.location.href="/"})}}}},63:function(t,e,r){"use strict";e.a={beforeMount(){const t=this.$watch("isAuth",e=>{e&&(this.$store.getters.isMine(this.$route.params.slug)||this.$router.replace({name:this.$route.name,params:{slug:this.$store.state.user.slug}}),t())})}}},65:function(t,e,r){"use strict";var n={name:"UserAvatar",props:{user:{type:Object,required:!0},avatar:{type:String,default:""},size:{type:Number,default:40},disabled:{type:Boolean,default:!1}}},o=r(1);var component=Object(o.a)(n,function(){var t=this,e=t.$createElement,r=t._self._c||e;return t.disabled?r("div",{staticClass:"user-avatar",style:{width:t.size+"px",height:t.size+"px"}},[t._ssrNode("<img"+t._ssrAttr("src",t.$resize(t.avatar||t.user.avatar,{width:t.size}))+t._ssrAttr("alt",t.user.nickname)+' class="avatar">')],2):r("nuxt-link",{staticClass:"user-avatar",style:{width:t.size+"px",height:t.size+"px"},attrs:{to:t.$alias.user(t.user.slug)}},[r("img",{staticClass:"avatar",attrs:{src:t.$resize(t.avatar||t.user.avatar,{width:t.size}),alt:t.user.nickname}})])},[],!1,function(t){var e=r(72);e.__inject__&&e.__inject__(t)},null,"8c0ebd70");e.a=component.exports},72:function(t,e,r){"use strict";r.r(e);var n=r(59),o=r.n(n);for(var c in n)"default"!==c&&function(t){r.d(e,t,function(){return n[t]})}(c);e.default=o.a},73:function(t,e,r){"use strict";r.r(e);var n=r(60),o=r.n(n);for(var c in n)"default"!==c&&function(t){r.d(e,t,function(){return n[t]})}(c);e.default=o.a},76:function(t,e){},77:function(t,e){},78:function(t,e){},79:function(t,e){},80:function(t,e){},81:function(t,e){},82:function(t,e){},83:function(t,e){},84:function(t,e){},85:function(t,e){},86:function(t,e){}};
//# sourceMappingURL=cf3c38f2edfb34943690.js.map