exports.ids=[30],exports.modules={105:function(e,t){},106:function(e,t,o){"use strict";o.r(t);var n=o(89),l=o.n(n);for(var r in n)"default"!==r&&function(e){o.d(t,e,function(){return n[e]})}(r);t.default=l.a},107:function(e,t){},144:function(e,t,o){"use strict";var n=o(51),l={name:"AreaPicker",components:{"el-cascader":o.n(n).a},props:{value:{type:Array,required:!0},placeholder:{type:String,default:"添加作品分区，如约会大作战"},blocked:{type:String,default:""}},data(){return{selected:this.value}},computed:{options(){let e=this.$store.state.global.myTags;return this.blocked&&(e=e.filter(e=>e.value!==this.blocked)),e}},watch:{value(e){this.selected=e},selected(e){this.$emit("input",e)}},mounted(){this.$store.dispatch("global/getMyTags"),this.$channel.$on("user-signed",()=>{this.$store.dispatch("global/getMyTags")})}},r=o(2);var component=Object(r.a)(l,function(){var e=this,t=e.$createElement,o=e._self._c||t;return o("div",{staticClass:"area-picker"},[e._ssrNode('<p class="tip">\n    提示：只能选择你通过了考试的分区\n  </p> '),o("el-cascader",{attrs:{placeholder:e.placeholder,options:e.options,filterable:""},scopedSlots:e._u([{key:"default",fn:function(t){var n=t.node,data=t.data;return[n.isLeaf?[o("span",[e._v(e._s(data.label))])]:[o("span",[e._v(e._s(data.label))]),e._v(" "),o("span",[e._v(" ("+e._s(data.children.length)+") ")])]]}}]),model:{value:e.selected,callback:function(t){e.selected=t},expression:"selected"}})],2)},[],!1,function(e){var t=o(106);t.__inject__&&t.__inject__(e)},null,"d07163b4");t.a=component.exports},150:function(e,t,o){"use strict";o.r(t);var n=o(105),l=o.n(n);for(var r in n)"default"!==r&&function(e){o.d(t,e,function(){return n[e]})}(r);t.default=l.a},151:function(e,t,o){"use strict";o.r(t);var n=o(107),l=o.n(n);for(var r in n)"default"!==r&&function(e){o.d(t,e,function(){return n[e]})}(r);t.default=l.a},184:function(e,t,o){"use strict";o.r(t);var n=o(50),l=o.n(n),r=o(88),d=o(83),c=o(84),h={name:"JsonEditor",mixins:[d.a],props:{value:{required:!0,type:Array},slug:{type:String,default:""},time:{type:String,default:""},autofocus:{type:Boolean,default:!1}},data:()=>({editor:null}),mounted(){this.initEditor()},methods:{initEditor(){Promise.all([Promise.resolve().then(o.t.bind(null,65,7)),Promise.resolve().then(o.t.bind(null,66,7)),Promise.resolve().then(o.t.bind(null,67,7)),Promise.resolve().then(o.t.bind(null,68,7)),Promise.resolve().then(o.t.bind(null,69,7)),Promise.resolve().then(o.t.bind(null,70,7)),Promise.resolve().then(o.t.bind(null,71,7)),Promise.resolve().then(o.t.bind(null,72,7))]).then(e=>{const t=this;let data={};if(t.slug){const e=t.$cache.get(`editor_local_draft-${t.slug}`);data=e&&e.time>new Date(t.time).getTime()?e:{blocks:t.value,time:Date.now(),version:t.$cache.get("editor_version","2.14.0")}}else t.$cache.has("editor_local_draft")&&(data=t.$cache.get("editor_local_draft"),t.$emit("input",data.blocks));const[o,n,l,r,d,h,m,f]=e.map(e=>e.default),v=new o({data:data,holder:"codex-editor",placeholder:"请输入内容",autofocus:t.autofocus,tools:{embed:{class:f,inlineToolbar:!0,config:{services:{bilibili:{regex:/https?:\/\/www\.bilibili\.com\/video\/av([^\\?\\&]*)/,embedUrl:"//player.bilibili.com/player.html?aid=<%= remote_id %>",html:"<iframe scrolling='no' border='0' frameborder='no' framespacing='0' allowtransparency='true' allowfullscreen='true'></iframe>"}}}},header:{class:n,shortcut:"CMD+SHIFT+H",inlineToolbar:!0},image:{class:h,shortcut:"CMD+SHIFT+P",types:"image/jpeg, image/png, image/jpg",config:{uploader:{uploadByFile:e=>new Promise((o,n)=>{const l=new FormData;l.append("file",e),l.append("token",t.uploadHeaders.token),Object(c.b)(t,l).then(data=>{data.url=`https://m1.calibur.tv/${data.url}`,o({success:1,file:data})}).catch(n)})}}},link:{class:d,shortcut:"CMD+SHIFT+L",config:{endpoint:"https://api.calibur.tv/v1/pin/editor/fetch_site"}},delimiter:r,list:{class:l,shortcut:"CMD+SHIFT+U",inlineToolbar:!0},checklist:{class:m,inlineToolbar:!0}},onChange:()=>{t.handleSave()}});v.isReady.then(()=>{this.editor=v,this.bindSaveEvent()}).catch(e=>{this.$toast.error(`编辑器初始化失败：${e}`)})})},bindSaveEvent(){document.addEventListener("keydown",e=>{83===e.keyCode&&(e.ctrlKey||e.metaKey)&&(e.stopPropagation(),e.preventDefault(),this.handleSave())},!1)},handleSave(){this.editor&&this.editor.save().then(e=>{const t=this.slug?`editor_local_draft-${this.slug}`:"editor_local_draft";this.$cache.set(t,e),this.$cache.set("editor_version",e.version),this.value&&this.$emit("input",e.blocks),this.$emit("save")}).catch(()=>{this.$toast.error("保存失败")})}}},m=o(2);var f={name:"Wander",layout:"web",components:{Editor:Object(m.a)(h,function(){var e=this.$createElement;return(this._self._c||e)("div",{staticClass:"editor-wrap"},[this._ssrNode('<div id="codex-editor" class="mousetrap"></div>')])},[],!1,function(e){var t=o(150);t.__inject__&&t.__inject__(e)},null,"57dddf00").exports,AreaPicker:o(144).a,"el-upload":l.a},mixins:[r.a,d.a],data:()=>({title:{banner:null,text:""},content:[],area:["topic","ugf6"],loading:!1}),mounted(){this.$cache.has("editor_local_draft_title")&&(this.title=this.$cache.get("editor_local_draft_title"))},methods:{customImageUploadSuccess(e,t){this.handleImageUploadSuccess(e,t);const o=e.data;o.width<960||o.height<540?this.handleImageUploadRemove(t):(this.title.banner=o,this.saveTitle())},onEditorSave(){this.saveTitle()},saveTitle(){this.$cache.set("editor_local_draft_title",this.title)},deleteBanner(){this.title.banner=null,this.saveTitle()},actionPublish(){this.loading||(this.title.text?this.content.length?(this.loading=!0,this.$axios.$post("v1/pin/create/story",{area:this.area[1],content:[{type:"title",data:this.title}].concat(this.content)}).then(e=>{this.$cache.remove("editor_local_draft_title"),this.$cache.remove("editor_local_draft"),window.location=this.$alias.pin(e)}).catch(e=>{this.$toast.error(e.message),this.loading=!1})):this.$toast.info("内容不能为空"):this.$toast.info("标题不能为空"))}}};var v=Object(m.a)(f,function(){var e=this,t=e.$createElement,o=e._self._c||t;return o("div",{attrs:{id:"wander"}},[e._ssrNode('<div class="wrap">',"</div>",[e._ssrNode('<div class="banner">',"</div>",[o("el-upload",{staticClass:"uploader",attrs:{drag:"",action:e.imageUploadAction,accept:e.imageUploadAccept,data:e.uploadHeaders,"before-upload":e.handleImageUploadBefore,"on-success":e.customImageUploadSuccess,"on-error":e.handleImageUploadError}},[o("div",{staticClass:"el-upload-tip",attrs:{slot:"tip"},slot:"tip"},[o("i",{staticClass:"el-icon-picture"}),e._v(" "),o("div",[e._v("请添加封面图（选填）")]),e._v(" "),o("p",[e._v("支持8MB内的JPG／JPEG／PNG格式的高清图片"),o("br"),e._v("（建议大于960*540像素）")])])]),e._ssrNode(" "),e.title.banner?[o("v-img",{attrs:{src:e.title.banner.url,width:"100%",height:"240"}}),e._ssrNode(' <div class="tool"><i class="el-icon-delete"></i></div>')]:e._e()],2),e._ssrNode(" "),e._ssrNode('<div class="title">',"</div>",[o("el-input",{attrs:{"show-word-limit":!0,autosize:{minRows:1},type:"textarea",resize:"none",placeholder:"请输入标题（建议30字以内）",maxlength:"40"},model:{value:e.title.text,callback:function(t){e.$set(e.title,"text",t)},expression:"title.text"}})],1),e._ssrNode(" "),o("editor",{on:{save:e.onEditorSave},model:{value:e.content,callback:function(t){e.content=t},expression:"content"}}),e._ssrNode(" "),o("el-form",{staticClass:"footer",attrs:{"label-position":"top","label-width":"80px"}},[o("el-form-item",{attrs:{label:"投稿板块"}},[o("area-picker",{model:{value:e.area,callback:function(t){e.area=t},expression:"area"}})],1),e._v(" "),o("el-form-item",[o("el-button",{attrs:{loading:e.loading,type:"primary",round:""},on:{click:e.actionPublish}},[e._v("\n          发表\n        ")])],1)],1)],2)])},[],!1,function(e){var t=o(151);t.__inject__&&t.__inject__(e)},null,"4b6246b4");t.default=v.exports},83:function(e,t,o){"use strict";var n=o(84);t.a={data:()=>({uploadHeaders:{key:"",token:""},uploadConfig:{max:5},uploadImageLimit:20,imageUploadAccept:["image/jpeg","image/png","image/jpg"].join(", "),imageUploadAction:"https://upload.qiniup.com",imagePrefix:"https://m1.calibur.tv/",getUpTokenTimer:0,uploadPending:0,uploadImageTotal:0,uploadImageList:[]}),computed:{currentUser(){return this.$store.state.user},isAuth(){return this.$store.state.isAuth}},watch:{isAuth(e){e&&this.initUpToken()}},mounted(){this.isAuth&&this.initUpToken()},beforeDestroy(){this.getUpTokenTimer&&clearInterval(this.getUpTokenTimer)},methods:{initUpToken(){this.getUpToken(),this.getUpTokenTimer=setInterval(()=>{this.getUpToken()},18e5)},async getUpToken(){let e=this.$cookie.get("UPLOAD-TOKEN");e?this.uploadHeaders.token=this.$cookie.get("UPLOAD-TOKEN"):(e=await Object(n.a)(this),this.uploadHeaders.token=e,this.$cookie.set("UPLOAD-TOKEN",e,{expires:new Date((new Date).getTime()+3e6)}))},handleImageUploadError(e,t){this.uploadImageList.forEach((o,n)=>{o.uid===t.uid&&(this.uploadPending--,this.uploadImageList.splice(n,1),console.log(e))}),this.$toast.error(`图片：${t.name} 上传失败`)},handleImageUploadRemove(e){this.uploadImageList.forEach((t,o)=>{t.uid===e.uid&&(this.uploadImageList.splice(o,1),this.uploadImageTotal--)})},handleImageUploadSuccess(e,t){this.uploadImageList.forEach((o,n)=>{o.uid===t.uid&&(this.uploadImageList[n]=Object.assign(o,{data:e.data,status:"success",url:this.$resize(`${this.imagePrefix}${e.data.url}`,{width:100})}))}),this.uploadImageTotal++,this.uploadPending--},handleImageUploadExceed(){this.$toast.info(`最多还能上传${this.uploadImageLimit-this.uploadImageTotal}张图片`)},handleImageUploadBefore(e){if(!this.isAuth)return this.$channel.$emit("sign-in"),!1;if(-1===this.imageUploadAccept.split(", ").indexOf(e.type))return this.$toast.error(`仅支持上传${this.imageUploadAccept.replace(/image\//g,"").replace(/, /g,"、")}格式的图片`),!1;if(this.uploadConfig.max&&this.uploadConfig.max<e.size/1024/1024)return this.$toast.error(`图片大小不能超过 ${this.uploadConfig.max}MB!`),!1;return this.uploadHeaders.key=(({slug:e,file:t})=>`${e}/${(new Date).getTime()}-${Math.random().toString(36).substring(3,6)}.${t.type.split("/").pop()}`)({slug:this.currentUser.slug,file:e}),this.uploadImageList.push({name:e.name,percentage:0,raw:e,size:e.size,status:"uploading",errMsg:"",uid:e.uid}),this.uploadPending++,!0}}}},84:function(e,t,o){"use strict";o.d(t,"a",function(){return n}),o.d(t,"b",function(){return l});const n=e=>e.$axios.$get("v1/image/uptoken"),l=(e,t)=>e.$axios.$post("https://up.qbox.me",t,{"Content-Type":"multipart/form-data"})},88:function(e,t,o){"use strict";var n=o(23);t.a={async beforeMount(){if(this.$store.state.logging){const e=this.$watch("$store.state.logging",()=>{this.$store.state.isAuth?(this.$channel.$emit("user-signed"),e()):this.$toast.error("继续操作前请先登录").then(()=>{window.location.href=this.$alias.sign()})})}else{const e=Object(n.a)();this.$store.commit("SET_USER_TOKEN",e),await this.$store.dispatch("initAuth")?this.$channel.$emit("user-signed"):this.$toast.error("继续操作前请先登录").then(()=>{window.location.href=this.$alias.sign()})}}}},89:function(e,t){}};
//# sourceMappingURL=10f7148da9bb2e85a777.js.map